generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String             @id @default(cuid())
  email                String             @unique
  firstName            String?
  lastName             String?
  phoneNumber          String?
  role                 UserRole           @default(MEMBER)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  emailVerified        DateTime?
  region               String?
  password             String?
  resetToken           String?            @unique
  resetTokenExpiry     DateTime?
  verificationToken    String?            @unique
  ubankId              String?            @unique
  activities           Activity[]
  createdAnnouncements Announcement[]     @relation("CreatedAnnouncements")
  contributions        Contribution[]
  groupMembers         GroupMember[]
  groupShares          GroupShare[]
  loans                Loan[]
  loanRepayments       LoanRepayment[]
  memberBankDetails    MemberBankDetail[]
  notifications        Notification[]
  passkeys             Passkey[]
  pushSubscriptions    PushSubscription[]
  reminders            Reminder[]
}

model Passkey {
  id           String    @id @default(cuid())
  credentialID String    @unique
  userId       String
  publicKey    Bytes
  counter      Int
  transports   String[]
  createdAt    DateTime  @default(now())
  lastUsedAt   DateTime?
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Group {
  id                       String           @id @default(cuid())
  name                     String
  description              String?
  region                   Region
  monthlyContribution      Float
  maxLoanMultiplier        Int              @default(3)
  interestRate             Float            @default(10)
  isActive                 Boolean          @default(true)
  createdById              String
  createdAt                DateTime         @default(now())
  updatedAt                DateTime         @updatedAt
  contributionDeadlineType MeetingFrequency @default(MONTHLY)
  contributionDueDay       Int              @default(5)
  lateContributionFee      Float            @default(0)
  lateMeetingFine          Float            @default(0)
  loanGracePeriodDays      Int              @default(0)
  loanInterestType         InterestType     @default(FLAT_RATE)
  meetingFrequency         MeetingFrequency @default(MONTHLY)
  missedMeetingFine        Float            @default(0)
  penaltyAmount            Float            @default(0)
  socialFundAmount         Float            @default(0)
  ubankId                  String?          @unique
  contactEmail             String?
  contactPhone             String?
  meetingLocation          String?
  minContributionMonths    Int              @default(3)
  cycleEndDate             DateTime?
  minLoanAmount            Float            @default(0)
  activities               Activity[]
  contributions            Contribution[]
  members                  GroupMember[]
  groupShares              GroupShare[]
  loans                    Loan[]
  paymentMethods           PaymentMethod[]
  reminders                Reminder[]
}

model GroupMember {
  id              String       @id @default(cuid())
  groupId         String
  userId          String
  role            GroupRole    @default(MEMBER)
  status          MemberStatus @default(PENDING)
  joinedAt        DateTime     @default(now())
  balance         Float        @default(0)
  unpaidPenalties Float        @default(0)
  group           Group        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([userId, status])
  @@index([groupId, status])
}

model Contribution {
  id              String        @id @default(cuid())
  groupId         String
  userId          String
  amount          Float
  month           Int
  year            Int
  paymentMethod   String?
  transactionRef  String?
  status          PaymentStatus @default(PENDING)
  createdAt       DateTime      @default(now())
  isLate          Boolean       @default(false)
  paymentDate     DateTime      @default(now())
  penaltyApplied  Float         @default(0)
  receiptUrl      String?
  rejectionReason String?
  reviewDate      DateTime?
  reviewedById    String?
  group           Group         @relation(fields: [groupId], references: [id])
  user            User          @relation(fields: [userId], references: [id])

  @@index([groupId, userId, month, year])
  @@index([status])
  @@index([userId, status])
  @@index([userId, status, createdAt])
}

model Loan {
  id                        String             @id @default(cuid())
  groupId                   String
  userId                    String
  amountRequested           Float
  amountApproved            Float?
  interestRate              Float
  repaymentPeriodMonths     Int
  status                    LoanStatus         @default(PENDING)
  approvedById              String?
  approvedAt                DateTime?
  createdAt                 DateTime           @default(now())
  updatedAt                 DateTime           @updatedAt
  rejectedAt                DateTime?
  rejectedById              String?
  rejectionReason           String?
  disbursementAccountName   String?
  disbursementAccountNumber String?
  disbursementBankName      String?
  disbursementMethod        PaymentMethodType?
  interestType              InterestType       @default(FLAT_RATE)
  group                     Group              @relation(fields: [groupId], references: [id])
  user                      User               @relation(fields: [userId], references: [id])
  repayments                LoanRepayment[]

  @@index([groupId, status])
  @@index([userId, status])
}

model LoanRepayment {
  id             String   @id @default(cuid())
  loanId         String
  amount         Float
  paymentMethod  String?
  transactionRef String?
  paidAt         DateTime @default(now())
  createdAt      DateTime @default(now())
  userId         String
  loan           Loan     @relation(fields: [loanId], references: [id])
  user           User     @relation(fields: [userId], references: [id])
}

model PaymentMethod {
  id            String            @id @default(cuid())
  groupId       String
  type          PaymentMethodType
  accountNumber String
  accountName   String
  isActive      Boolean           @default(true)
  addedById     String
  createdAt     DateTime          @default(now())
  bankName      String?
  group         Group             @relation(fields: [groupId], references: [id])
}

model Activity {
  id          String   @id @default(cuid())
  userId      String
  groupId     String?
  actionType  String
  description String
  metadata    Json?
  createdAt   DateTime @default(now())
  group       Group?   @relation(fields: [groupId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId, groupId, createdAt])
  @@index([groupId, createdAt])
}

model Notification {
  id         String           @id @default(cuid())
  userId     String
  type       NotificationType @default(INFO)
  title      String
  message    String
  read       Boolean          @default(false)
  actionUrl  String?
  actionText String?
  createdAt  DateTime         @default(now())
  user       User             @relation(fields: [userId], references: [id])

  @@index([userId, read])
  @@index([userId, createdAt])
}

model GroupShare {
  id            String          @id @default(cuid())
  groupId       String
  sharedById    String
  shareToken    String          @unique
  shareType     ShareType       @default(QR_CODE)
  permissions   SharePermission @default(REQUEST_JOIN)
  expiresAt     DateTime?
  maxUses       Int?            @default(10)
  currentUses   Int             @default(0)
  customMessage String?
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  group         Group           @relation(fields: [groupId], references: [id])
  sharedBy      User            @relation(fields: [sharedById], references: [id])
  qrAnalytics   QrAnalytics[]

  @@index([shareToken])
  @@index([groupId])
}

model QrAnalytics {
  id                String     @id @default(cuid())
  groupShareId      String
  scannedAt         DateTime   @default(now())
  ipAddress         String?
  userAgent         String?
  location          String?
  convertedToMember Boolean    @default(false)
  groupShare        GroupShare @relation(fields: [groupShareId], references: [id], onDelete: Cascade)
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model MemberBankDetail {
  id            String            @id @default(cuid())
  userId        String
  type          PaymentMethodType
  bankName      String?
  accountNumber String
  accountName   String
  isPrimary     Boolean           @default(false)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Reminder {
  id          String       @id @default(cuid())
  title       String
  description String?
  datetime    DateTime
  type        ReminderType @default(MEETING)
  link        String?
  userId      String
  groupId     String?
  isRead      Boolean      @default(false)
  createdAt   DateTime     @default(now())
  group       Group?       @relation(fields: [groupId], references: [id])
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, datetime])
  @@index([groupId, datetime])
}

model Announcement {
  id          String           @id @default(cuid())
  title       String
  message     String
  imageUrl    String?
  link        String?
  type        AnnouncementType @default(BANNER)
  isActive    Boolean          @default(true)
  expiresAt   DateTime?
  createdAt   DateTime         @default(now())
  createdById String
  actionText  String?
  createdBy   User             @relation("CreatedAnnouncements", fields: [createdById], references: [id])
}

enum UserRole {
  MEMBER
  REGIONAL_ADMIN
  SUPER_ADMIN
}

enum Region {
  NORTHERN
  SOUTHERN
  CENTRAL
}

enum MeetingFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum InterestType {
  FLAT_RATE
  REDUCING_BALANCE
}

enum GroupRole {
  ADMIN
  TREASURER
  SECRETARY
  MEMBER
}

enum MemberStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REJECTED
}

enum LoanStatus {
  PENDING
  APPROVED
  REJECTED
  ACTIVE
  COMPLETED
  DEFAULTED
}

enum PaymentMethodType {
  AIRTEL_MONEY
  MPAMBA
  BANK_CARD
  CASH
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

enum ShareType {
  QR_CODE
  DIRECT_LINK
  EMAIL_INVITE
}

enum SharePermission {
  VIEW_ONLY
  REQUEST_JOIN
  LIMITED_ACCESS
  FULL_PREVIEW
}

enum ReminderType {
  MEETING
  PAYMENT
  GENERAL
}

enum AnnouncementType {
  BANNER
  BROADCAST_ONLY
}
