generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  ubankTag          String?            @unique
  firstName         String?
  lastName          String?
  phoneNumber       String?
  region            String?
  role              UserRole           @default(MEMBER)
  emailVerified     DateTime?          @default(now())
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  password          String?
  resetToken        String?            @unique
  resetTokenExpiry  DateTime?
  activities        Activity[]
  contributions     Contribution[]
  groupMembers      GroupMember[]
  groupShares       GroupShare[]
  loans             Loan[]
  loanRepayments    LoanRepayment[]
  memberBankDetails MemberBankDetail[]
  notifications     Notification[]
  pushSubscriptions PushSubscription[]
}

model Group {
  id                       String           @id @default(cuid())
  name                     String
  ubankTag                 String?          @unique
  description              String?
  region                   Region
  meetingFrequency         MeetingFrequency @default(MONTHLY)
  monthlyContribution      Float
  socialFundAmount         Float            @default(0)
  maxLoanMultiplier        Int              @default(3)
  interestRate             Float            @default(10)
  loanInterestType         InterestType     @default(FLAT_RATE)
  penaltyAmount            Float            @default(0)
  lateContributionFee      Float            @default(0)
  lateMeetingFine          Float            @default(0)
  missedMeetingFine        Float            @default(0)
  contributionDueDay       Int              @default(5)
  contributionDeadlineType MeetingFrequency @default(MONTHLY)
  loanGracePeriodDays      Int              @default(0)
  isActive                 Boolean          @default(true)
  createdById              String
  createdAt                DateTime         @default(now())
  updatedAt                DateTime         @updatedAt
  activities               Activity[]
  contributions            Contribution[]
  members                  GroupMember[]
  groupShares              GroupShare[]
  loans                    Loan[]
  paymentMethods           PaymentMethod[]
}

model GroupMember {
  id              String       @id @default(cuid())
  groupId         String
  userId          String
  role            GroupRole    @default(MEMBER)
  status          MemberStatus @default(PENDING)
  joinedAt        DateTime     @default(now())
  balance         Float        @default(0)
  unpaidPenalties Float        @default(0)
  group           Group        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
}

model Contribution {
  id              String        @id @default(cuid())
  groupId         String
  userId          String
  amount          Float
  month           Int
  year            Int
  paymentDate     DateTime      @default(now())
  paymentMethod   String?
  transactionRef  String?
  receiptUrl      String?
  status          PaymentStatus @default(PENDING)
  penaltyApplied  Float         @default(0)
  isLate          Boolean       @default(false)
  reviewedById    String?
  reviewDate      DateTime?
  rejectionReason String?
  createdAt       DateTime      @default(now())
  group           Group         @relation(fields: [groupId], references: [id])
  user            User          @relation(fields: [userId], references: [id])

  @@index([groupId, userId, month, year])
  @@index([status])
  @@index([userId, status])
}

model Loan {
  id                        String             @id @default(cuid())
  groupId                   String
  userId                    String
  amountRequested           Float
  amountApproved            Float?
  interestRate              Float
  repaymentPeriodMonths     Int
  status                    LoanStatus         @default(PENDING)
  approvedById              String?
  approvedAt                DateTime?
  rejectedById              String?
  rejectedAt                DateTime?
  rejectionReason           String?
  createdAt                 DateTime           @default(now())
  updatedAt                 DateTime           @updatedAt
  disbursementMethod        PaymentMethodType?
  disbursementAccountName   String?
  disbursementAccountNumber String?
  disbursementBankName      String?
  group                     Group              @relation(fields: [groupId], references: [id])
  user                      User               @relation(fields: [userId], references: [id])
  repayments                LoanRepayment[]

  @@index([groupId, status])
  @@index([userId, status])
}

model LoanRepayment {
  id             String   @id @default(cuid())
  loanId         String
  userId         String
  amount         Float
  paymentMethod  String?
  transactionRef String?
  paidAt         DateTime @default(now())
  createdAt      DateTime @default(now())
  loan           Loan     @relation(fields: [loanId], references: [id])
  user           User     @relation(fields: [userId], references: [id])
}

model PaymentMethod {
  id            String            @id @default(cuid())
  groupId       String
  type          PaymentMethodType
  accountNumber String
  accountName   String
  isActive      Boolean           @default(true)
  addedById     String
  createdAt     DateTime          @default(now())
  group         Group             @relation(fields: [groupId], references: [id])
}

model Activity {
  id          String   @id @default(cuid())
  userId      String
  groupId     String?
  actionType  String
  description String
  metadata    Json?
  createdAt   DateTime @default(now())
  group       Group?   @relation(fields: [groupId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId, groupId, createdAt])
  @@index([groupId, createdAt])
}

model Notification {
  id         String           @id @default(cuid())
  userId     String
  type       NotificationType @default(INFO)
  title      String
  message    String
  read       Boolean          @default(false)
  actionUrl  String?
  actionText String?
  createdAt  DateTime         @default(now())
  user       User             @relation(fields: [userId], references: [id])

  @@index([userId, read])
  @@index([userId, createdAt])
}

model GroupShare {
  id            String          @id @default(cuid())
  groupId       String
  sharedById    String
  shareToken    String          @unique
  shareType     ShareType       @default(QR_CODE)
  permissions   SharePermission @default(REQUEST_JOIN)
  expiresAt     DateTime?
  maxUses       Int?            @default(10)
  currentUses   Int             @default(0)
  customMessage String?
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  group         Group           @relation(fields: [groupId], references: [id])
  sharedBy      User            @relation(fields: [sharedById], references: [id])
  qrAnalytics   QrAnalytics[]

  @@index([shareToken])
  @@index([groupId])
}

model QrAnalytics {
  id                String     @id @default(cuid())
  groupShareId      String
  scannedAt         DateTime   @default(now())
  ipAddress         String?
  userAgent         String?
  location          String?
  convertedToMember Boolean    @default(false)
  groupShare        GroupShare @relation(fields: [groupShareId], references: [id], onDelete: Cascade)
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model MemberBankDetail {
  id            String            @id @default(cuid())
  userId        String
  type          PaymentMethodType
  bankName      String?
  accountNumber String
  accountName   String
  isPrimary     Boolean           @default(false)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum UserRole {
  MEMBER
  REGIONAL_ADMIN
  SUPER_ADMIN
}

enum Region {
  NORTHERN
  SOUTHERN
  CENTRAL
}

enum MeetingFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum InterestType {
  FLAT_RATE
  REDUCING_BALANCE
}

enum GroupRole {
  ADMIN
  TREASURER
  SECRETARY
  MEMBER
}

enum MemberStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REJECTED
}

enum LoanStatus {
  PENDING
  APPROVED
  REJECTED
  ACTIVE
  COMPLETED
  DEFAULTED
}

enum PaymentMethodType {
  AIRTEL_MONEY
  MPAMBA
  BANK_CARD
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

enum ShareType {
  QR_CODE
  DIRECT_LINK
  EMAIL_INVITE
}

enum SharePermission {
  VIEW_ONLY
  REQUEST_JOIN
  LIMITED_ACCESS
  FULL_PREVIEW
}
