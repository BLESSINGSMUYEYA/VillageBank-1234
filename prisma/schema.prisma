// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  firstName     String?
  lastName      String?
  phoneNumber   String?
  region        String?
  role          UserRole  @default(MEMBER)
  emailVerified DateTime? @default(now())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  groupMembers    GroupMember[]
  contributions    Contribution[]
  loans           Loan[]
  loanRepayments  LoanRepayment[]
  activities      Activity[]
  notifications   Notification[]
  groupShares     GroupShare[]
}

enum UserRole {
  MEMBER
  REGIONAL_ADMIN
  SUPER_ADMIN
}

enum Region {
  NORTHERN
  SOUTHERN
  CENTRAL
}

model Group {
  id                      String   @id @default(cuid())
  name                    String
  description             String?
  region                  Region
  monthlyContribution     Float
  maxLoanMultiplier       Int      @default(3)
  interestRate            Float    @default(10)
  penaltyAmount           Float    @default(0)
  contributionDueDay      Int      @default(5)
  isActive                Boolean  @default(true)
  createdById             String
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  members                 GroupMember[]
  contributions           Contribution[]
  loans                   Loan[]
  paymentMethods          PaymentMethod[]
  activities              Activity[]
  groupShares             GroupShare[]
}

model GroupMember {
  id        String           @id @default(cuid())
  groupId   String
  userId    String
  role      GroupRole        @default(MEMBER)
  status    MemberStatus     @default(PENDING)
  joinedAt  DateTime         @default(now())
  
  group     Group   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  balance          Float @default(0) // (+) for overpayment/credit, (-) for debt/owed
  unpaidPenalties  Float @default(0) // Total accumulated penalties not yet paid
  
  @@unique([groupId, userId])
}

enum GroupRole {
  ADMIN
  TREASURER
  SECRETARY
  MEMBER
}

enum MemberStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

model Contribution {
  id                  String             @id @default(cuid())
  groupId             String
  userId              String
  amount              Float
  month               Int
  year                Int
  paymentMethod       String?
  transactionRef      String?
  receiptUrl          String?
  status              PaymentStatus      @default(PENDING)
  penaltyApplied      Float              @default(0)
  isLate              Boolean            @default(false)
  reviewedById        String?
  reviewDate          DateTime?
  rejectionReason     String?
  createdAt           DateTime           @default(now())
  
  group               Group   @relation(fields: [groupId], references: [id])
  user                User    @relation(fields: [userId], references: [id])
  
  @@index([groupId, userId, month, year])
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REJECTED
}

model Loan {
  id                    String       @id @default(cuid())
  groupId               String
  userId                String
  amountRequested       Float
  amountApproved        Float?
  interestRate          Float
  repaymentPeriodMonths Int
  status                LoanStatus   @default(PENDING)
  approvedById          String?
  approvedAt            DateTime?
  rejectedById          String?
  rejectedAt            DateTime?
  rejectionReason       String?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  
  group                 Group          @relation(fields: [groupId], references: [id])
  user                  User           @relation(fields: [userId], references: [id])
  repayments            LoanRepayment[]
}

enum LoanStatus {
  PENDING
  APPROVED
  REJECTED
  ACTIVE
  COMPLETED
  DEFAULTED
}

model LoanRepayment {
  id              String   @id @default(cuid())
  loanId          String
  userId          String
  amount          Float
  paymentMethod   String?
  transactionRef  String?
  paidAt          DateTime @default(now())
  createdAt       DateTime @default(now())
  
  loan            Loan     @relation(fields: [loanId], references: [id])
  user            User     @relation(fields: [userId], references: [id])
}

model PaymentMethod {
  id            String              @id @default(cuid())
  groupId       String
  type          PaymentMethodType
  accountNumber String
  accountName   String
  isActive      Boolean             @default(true)
  addedById     String
  createdAt     DateTime            @default(now())
  
  group         Group               @relation(fields: [groupId], references: [id])
}

enum PaymentMethodType {
  AIRTEL_MONEY
  MPAMBA
  BANK_CARD
}

model Activity {
  id          String   @id @default(cuid())
  userId      String
  groupId     String?
  actionType  String
  description String
  metadata    Json?
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id])
  group       Group?   @relation(fields: [groupId], references: [id])
}

model Notification {
  id         String              @id @default(cuid())
  userId     String
  type       NotificationType    @default(INFO)
  title      String
  message    String
  read       Boolean             @default(false)
  actionUrl  String?
  actionText String?
  createdAt  DateTime            @default(now())
  
  user       User                @relation(fields: [userId], references: [id])
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

model GroupShare {
  id          String      @id @default(cuid())
  groupId     String
  sharedById  String
  shareToken  String      @unique
  shareType   ShareType   @default(QR_CODE)
  permissions SharePermission @default(REQUEST_JOIN)
  expiresAt   DateTime?
  maxUses     Int?        @default(10)
  currentUses Int         @default(0)
  customMessage String?   @db.Text
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  
  group       Group       @relation(fields: [groupId], references: [id])
  sharedBy    User        @relation(fields: [sharedById], references: [id])
  qrAnalytics QrAnalytics[]
  
  @@index([shareToken])
  @@index([groupId])
}

model QrAnalytics {
  id           String   @id @default(cuid())
  groupShareId String
  scannedAt    DateTime @default(now())
  ipAddress    String?
  userAgent    String?
  location     String?
  convertedToMember Boolean @default(false)
  
  groupShare   GroupShare @relation(fields: [groupShareId], references: [id], onDelete: Cascade)
}

enum ShareType {
  QR_CODE
  DIRECT_LINK
  EMAIL_INVITE
}

enum SharePermission {
  VIEW_ONLY        // Can only see group info
  REQUEST_JOIN     // Can view and request to join
  LIMITED_ACCESS   // Can view some features
  FULL_PREVIEW     // Can see most features except sensitive data
}
